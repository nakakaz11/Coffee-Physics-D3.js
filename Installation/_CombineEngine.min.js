var Attraction,Behaviour,Collision,ConstantForce,Demo,EdgeBounce,EdgeWrap,Euler,ImprovedEuler,Integrator,Particle,Physics,Random,Renderer,Spring,Vector,Verlet,Wander,d3SVGRenderer,end,namespace,_ref,_ref1,_ref2,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};end=null;Random=function(min,max){if(max==null){max=min;min=0}return min+Math.random()*(max-min)};Random.int=function(min,max){if(max==null){max=min;min=0}return Math.floor(min+Math.random()*(max-min))};Random.sign=function(prob){if(prob==null){prob=.5}if(Math.random()<prob){return 1}else{return-1}};Random.bool=function(prob){if(prob==null){prob=.5}return Math.random()<prob};Random.item=function(list){return list[Math.floor(Math.random()*list.length)]};Vector=function(){Vector.add=function(v1,v2){return new Vector(v1.x+v2.x,v1.y+v2.y)};Vector.sub=function(v1,v2){return new Vector(v1.x-v2.x,v1.y-v2.y)};Vector.project=function(v1,v2){return v1.clone().scale(v1.dot(v2)/v1.magSq())};function Vector(x,y){this.x=x!=null?x:0;this.y=y!=null?y:0}Vector.prototype.set=function(x,y){this.x=x;this.y=y;return this};Vector.prototype.add=function(v){this.x+=v.x;this.y+=v.y;return this};Vector.prototype.sub=function(v){this.x-=v.x;this.y-=v.y;return this};Vector.prototype.scale=function(f){this.x*=f;this.y*=f;return this};Vector.prototype.dot=function(v){return this.x*v.x+this.y*v.y};Vector.prototype.cross=function(v){return this.x*v.y-this.y*v.x};Vector.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vector.prototype.magSq=function(){return this.x*this.x+this.y*this.y};Vector.prototype.dist=function(v){var dx,dy;dx=v.x-this.x;dy=v.y-this.y;return Math.sqrt(dx*dx+dy*dy)};Vector.prototype.distSq=function(v){var dx,dy;dx=v.x-this.x;dy=v.y-this.y;return dx*dx+dy*dy};Vector.prototype.norm=function(){var m;m=Math.sqrt(this.x*this.x+this.y*this.y);this.x/=m;this.y/=m;return this};Vector.prototype.limit=function(l){var m,mSq;mSq=this.x*this.x+this.y*this.y;if(mSq>l*l){m=Math.sqrt(mSq);this.x/=m;this.y/=m;this.x*=l;this.y*=l;return this}};Vector.prototype.copy=function(v){this.x=v.x;this.y=v.y;return this};Vector.prototype.clone=function(){return new Vector(this.x,this.y)};Vector.prototype.clear=function(){this.x=0;this.y=0;return this};return Vector}();Integrator=function(){function Integrator(){}Integrator.prototype.integrate=function(particles,dt){};return Integrator}();Euler=function(_super){__extends(Euler,_super);function Euler(){_ref=Euler.__super__.constructor.apply(this,arguments);return _ref}Euler.prototype.integrate=function(particles,dt,drag){var p,vel,_i,_len,_results;vel=new Vector;_results=[];for(_i=0,_len=particles.length;_i<_len;_i++){p=particles[_i];if(!!p.fixed){continue}p.old.pos.copy(p.pos);p.acc.scale(p.massInv);vel.copy(p.vel);p.vel.add(p.acc.scale(dt));p.pos.add(vel.scale(dt));if(drag){p.vel.scale(drag)}_results.push(p.acc.clear())}return _results};return Euler}(Integrator);ImprovedEuler=function(_super){__extends(ImprovedEuler,_super);function ImprovedEuler(){_ref1=ImprovedEuler.__super__.constructor.apply(this,arguments);return _ref1}ImprovedEuler.prototype.integrate=function(particles,dt,drag){var acc,dtSq,p,vel,_i,_len,_results;acc=new Vector;vel=new Vector;dtSq=dt*dt;_results=[];for(_i=0,_len=particles.length;_i<_len;_i++){p=particles[_i];if(!!p.fixed){continue}p.old.pos.copy(p.pos);p.acc.scale(p.massInv);vel.copy(p.vel);acc.copy(p.acc);p.pos.add(vel.scale(dt).add(acc.scale(.5*dtSq)));p.vel.add(p.acc.scale(dt));if(drag){p.vel.scale(drag)}_results.push(p.acc.clear())}return _results};return ImprovedEuler}(Integrator);Verlet=function(_super){__extends(Verlet,_super);function Verlet(){_ref2=Verlet.__super__.constructor.apply(this,arguments);return _ref2}Verlet.prototype.integrate=function(particles,dt,drag){var dtSq,p,pos,_i,_len,_results;pos=new Vector;dtSq=dt*dt;_results=[];for(_i=0,_len=particles.length;_i<_len;_i++){p=particles[_i];if(!!p.fixed){continue}p.acc.scale(p.massInv);p.vel.copy(p.pos).sub(p.old.pos);if(drag){p.vel.scale(drag)}pos.copy(p.pos).add(p.vel.add(p.acc.scale(dtSq)));p.old.pos.copy(p.pos);p.pos.copy(pos);_results.push(p.acc.clear())}return _results};return Verlet}(Integrator);Particle=function(){Particle.GUID=0;function Particle(mass){this.mass=mass!=null?mass:1;this.id="p"+Particle.GUID++;this.setMass(this.mass);this.setRadius(1);this.fixed=false;this.behaviours=[];this.pos=new Vector;this.vel=new Vector;this.acc=new Vector;this.old={pos:new Vector,vel:new Vector,acc:new Vector}}Particle.prototype.moveTo=function(pos){this.pos.copy(pos);return this.old.pos.copy(pos)};Particle.prototype.setMass=function(mass){this.mass=mass!=null?mass:1;return this.massInv=1/this.mass};Particle.prototype.setRadius=function(radius){this.radius=radius!=null?radius:1;return this.radiusSq=this.radius*this.radius};Particle.prototype.update=function(dt,index){var behaviour,_i,_len,_ref3,_results;if(!this.fixed){_ref3=this.behaviours;_results=[];for(_i=0,_len=_ref3.length;_i<_len;_i++){behaviour=_ref3[_i];_results.push(behaviour.apply(this,dt,index))}return _results}};return Particle}();Physics=function(){var _swns;_swns={};function Physics(integrator,_config){this.integrator=integrator!=null?integrator:new Euler;_swns.config=_config;this.timestep=1/60;this.viscosity=_swns.config._viscosity||.87;this.behaviours=[];this._time=0;this._step=0;this._clock=null;this._buffer=0;this._maxSteps=4;this.particles=[];this.springs=[]}Physics.prototype.integrate=function(dt){var behaviour,drag,index,particle,spring,_i,_j,_k,_len,_len1,_len2,_ref3,_ref4,_ref5,_results;drag=1-this.viscosity;_ref3=this.particles;for(index=_i=0,_len=_ref3.length;_i<_len;index=++_i){particle=_ref3[index];_ref4=this.behaviours;for(_j=0,_len1=_ref4.length;_j<_len1;_j++){behaviour=_ref4[_j];behaviour.apply(particle,dt,index)}particle.update(dt,index)}this.integrator.integrate(this.particles,dt,drag);_ref5=this.springs;_results=[];for(_k=0,_len2=_ref5.length;_k<_len2;_k++){spring=_ref5[_k];_results.push(spring.apply())}return _results};Physics.prototype.step=function(){var delta,i,time;if(this._clock==null){this._clock=(new Date).getTime()}time=(new Date).getTime();delta=time-this._clock;if(delta<=0){return}delta*=.001;this._clock=time;this._buffer+=delta;i=0;while(this._buffer>=this.timestep&&++i<this._maxSteps){this.integrate(this.timestep);this._buffer-=this.timestep;this._time+=this.timestep}return this._step=(new Date).getTime()-time};Physics.prototype.destroy=function(){this.integrator=null;this.particles=null;return this.springs=null};return Physics}();Spring=function(){function Spring(p1,p2,restLength,stiffness){this.p1=p1;this.p2=p2;this.restLength=restLength!=null?restLength:100;this.stiffness=stiffness!=null?stiffness:1;this._delta=new Vector}Spring.prototype.apply=function(){var dist,force;this._delta.copy(this.p2.pos).sub(this.p1.pos);dist=this._delta.mag()+1e-6;force=(dist-this.restLength)/(dist*(this.p1.massInv+this.p2.massInv))*this.stiffness;if(!this.p1.fixed){this.p1.pos.add(this._delta.clone().scale(force*this.p1.massInv))}if(!this.p2.fixed){return this.p2.pos.add(this._delta.scale(-force*this.p2.massInv))}};return Spring}();Behaviour=function(){Behaviour.GUID=0;function Behaviour(){this.GUID=Behaviour.GUID++;this.interval=1}Behaviour.prototype.apply=function(p,dt,index){var _name;return(p[_name="__behaviour"+this.GUID]!=null?p[_name="__behaviour"+this.GUID]:p[_name]={counter:0}).counter++};return Behaviour}();Attraction=function(_super){__extends(Attraction,_super);function Attraction(target,radius,strength){this.target=target!=null?target:new Vector;this.radius=radius!=null?radius:1e3;this.strength=strength!=null?strength:100;this._delta=new Vector;this.setRadius(this.radius);Attraction.__super__.constructor.apply(this,arguments)}Attraction.prototype.setRadius=function(radius){this.radius=radius;return this.radiusSq=radius*radius};Attraction.prototype.apply=function(p,dt,index){var distSq;this._delta.copy(this.target).sub(p.pos);distSq=this._delta.magSq();if(distSq<this.radiusSq&&distSq>1e-6){this._delta.norm().scale(1-distSq/this.radiusSq);return p.acc.add(this._delta.scale(this.strength))}};return Attraction}(Behaviour);Collision=function(_super){__extends(Collision,_super);function Collision(useMass,callback){this.useMass=useMass!=null?useMass:true;this.callback=callback!=null?callback:null;this.pool=[];this._delta=new Vector;Collision.__super__.constructor.apply(this,arguments)}Collision.prototype.apply=function(p,dt,index){var dist,distSq,mt,o,overlap,r1,r2,radii,_i,_len,_ref3,_results;_ref3=this.pool.slice(index);_results=[];for(_i=0,_len=_ref3.length;_i<_len;_i++){o=_ref3[_i];if(!(o!==p)){continue}this._delta.copy(o.pos).sub(p.pos);distSq=this._delta.magSq();radii=p.radius+o.radius;if(distSq<=radii*radii){dist=Math.sqrt(distSq);overlap=p.radius+o.radius-dist;overlap+=.5;mt=p.mass+o.mass;r1=this.useMass?o.mass/mt:.5;r2=this.useMass?p.mass/mt:.5;p.pos.add(this._delta.clone().norm().scale(overlap*-r1));o.pos.add(this._delta.norm().scale(overlap*r2));_results.push(typeof this.callback==="function"?this.callback(p,o,overlap):void 0)}else{_results.push(void 0)}}return _results};return Collision}(Behaviour);ConstantForce=function(_super){__extends(ConstantForce,_super);function ConstantForce(force){this.force=force!=null?force:new Vector;ConstantForce.__super__.constructor.apply(this,arguments)}ConstantForce.prototype.apply=function(p,dt,index){return p.acc.add(this.force)};return ConstantForce}(Behaviour);EdgeBounce=function(_super){__extends(EdgeBounce,_super);function EdgeBounce(min,max){this.min=min!=null?min:new Vector;this.max=max!=null?max:new Vector;EdgeBounce.__super__.constructor.apply(this,arguments)}EdgeBounce.prototype.apply=function(p,dt,index){if(p.pos.x-p.radius<this.min.x){p.pos.x=this.min.x+p.radius}else if(p.pos.x+p.radius>this.max.x){p.pos.x=this.max.x-p.radius}if(p.pos.y-p.radius<this.min.y){return p.pos.y=this.min.y+p.radius}else if(p.pos.y+p.radius>this.max.y){return p.pos.y=this.max.y-p.radius}};return EdgeBounce}(Behaviour);EdgeWrap=function(_super){__extends(EdgeWrap,_super);function EdgeWrap(min,max){this.min=min!=null?min:new Vector;this.max=max!=null?max:new Vector;EdgeWrap.__super__.constructor.apply(this,arguments)}EdgeWrap.prototype.apply=function(p,dt,index){if(p.pos.x+p.radius<this.min.x){p.pos.x=this.max.x+p.radius;p.old.pos.x=p.pos.x}else if(p.pos.x-p.radius>this.max.x){p.pos.x=this.min.x-p.radius;p.old.pos.x=p.pos.x}if(p.pos.y+p.radius<this.min.y){p.pos.y=this.max.y+p.radius;return p.old.pos.y=p.pos.y}else if(p.pos.y-p.radius>this.max.y){p.pos.y=this.min.y-p.radius;return p.old.pos.y=p.pos.y}};return EdgeWrap}(Behaviour);Wander=function(_super){__extends(Wander,_super);function Wander(jitter,radius,strength){this.jitter=jitter!=null?jitter:.5;this.radius=radius!=null?radius:100;this.strength=strength!=null?strength:1;this.theta=Math.random()*Math.PI*2;Wander.__super__.constructor.apply(this,arguments)}Wander.prototype.apply=function(p,dt,index){this.theta+=(Math.random()-.5)*this.jitter*Math.PI*2;p.acc.x+=Math.cos(this.theta)*this.radius*this.strength;return p.acc.y+=Math.sin(this.theta)*this.radius*this.strength};return Wander}(Behaviour);namespace=function(id){var path,root,_i,_len,_ref3,_results;root=self;_ref3=id.split(".");_results=[];for(_i=0,_len=_ref3.length;_i<_len;_i++){path=_ref3[_i];_results.push(root=root[path]!=null?root[path]:root[path]={})}return _results};!function(){var time,vendor,vendors,_i,_len;time=0;vendors=["ms","moz","webkit","o"];for(_i=0,_len=vendors.length;_i<_len;_i++){vendor=vendors[_i];if(!!window.requestAnimationFrame){continue}window.requestAnimationFrame=window[vendor+"RequestAnimationFrame"];window.cancelRequestAnimationFrame=window[vendor+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(callback,element){var delta,now,old;now=(new Date).getTime();delta=Math.max(0,16-(now-old));setTimeout(function(){return callback(time+delta)},delta);return old=now+delta}}if(!window.cancelAnimationFrame){return window.cancelAnimationFrame=function(id){return clearTimeout(id)}}}();Demo=function(){var _swns;Demo.COLOURSinit=["f0f0f0","d9d9d9","bdbdbd","969696","737373","525252","252525","000000"];_swns={};function Demo(globalSwobj,_config){this.mousemove=__bind(this.mousemove,this);this.resize=__bind(this.resize,this);_swns.opt=globalSwobj;_swns.config=_config;this.physics=new Physics(null,_config);this.mouse=new Particle;this.mouse.fixed=true;this.height=window.innerHeight;this.width=window.innerWidth;this.renderTime=0;this.counter=0}Demo.prototype.setup=function(full){if(full==null){return full=true}};Demo.prototype.init=function(container,renderer){var particle,_i,_len,_ref3;this.container=container;this.renderer=renderer!=null?renderer:new WebGLRenderer;this.setup(renderer.gl!=null);_ref3=this.physics.particles;for(_i=0,_len=_ref3.length;_i<_len;_i++){particle=_ref3[_i];if(particle.colour==null){particle.colour=Random.item(_swns.config._COLOURS||Demo.COLOURSinit)}}document.addEventListener("touchmove",this.mousemove,false);document.addEventListener("mousemove",this.mousemove,false);document.addEventListener("resize",this.resize,false);this.container.appendChild(this.renderer.domElement);this.renderer.mouse=this.mouse;this.renderer.init(this.physics);return this.resize()};Demo.prototype.resize=function(event){this.width=window.innerWidth;this.height=window.innerHeight;return this.renderer.setSize(this.width,this.height)};Demo.prototype.step=function(){this.physics.step();if(this.renderer.gl!=null||++this.counter%3===0){return this.renderer.render(this.physics)}};Demo.prototype.destroy=function(){var error;document.removeEventListener("touchmove",this.mousemove,false);document.removeEventListener("mousemove",this.mousemove,false);document.removeEventListener("resize",this.resize,false);try{container.removeChild(this.renderer.domElement)}catch(_error){error=_error}this.renderer.destroy();this.physics.destroy();this.renderer=null;this.physics=null;return this.mouse=null};Demo.prototype.mousemove=function(event){var touch;event.preventDefault();if(event.touches&&!!event.touches.length){touch=event.touches[0];return this.mouse.pos.set(touch.pageX,touch.pageY)}else{return this.mouse.pos.set(event.clientX,event.clientY)}};return Demo}();Renderer=function(){function Renderer(){this.setSize=__bind(this.setSize,this);this.width=0;this.height=0;this.renderParticles=true;this.renderSprings=true;this.renderMouse=true;this.initialized=false;this.renderTime=0}Renderer.prototype.init=function(physics){return this.initialized=true};Renderer.prototype.render=function(physics){if(!this.initialized){return this.init(physics)}};Renderer.prototype.setSize=function(width,height){this.width=width;this.height=height};Renderer.prototype.destroy=function(){};return Renderer}();d3SVGRenderer=function(_super){var _d3ns,_swns;__extends(d3SVGRenderer,_super);_swns={};_d3ns={};function d3SVGRenderer(globalSwobj,_config,d3ns){this.setSize=__bind(this.setSize,this);d3SVGRenderer.__super__.constructor.apply(this,arguments);this.domElement=document.createElement("div");_swns.opt=globalSwobj;_swns.config=_config;_d3ns=d3ns;this.width=window.innerWidth;this.height=window.innerHeight;_d3ns.svg=d3.select("#container").append("svg").attr("width",window.innerWidth).attr("height",window.innerHeight)}d3SVGRenderer.prototype.init=function(physics){d3SVGRenderer.__super__.init.call(this,physics);_d3ns.voronoiVertices=[];_d3ns.vPath=_d3ns.svg.selectAll(".vPath");_d3ns.vLink=_d3ns.svg.selectAll(".vLink");_d3ns.edge=function(a,b){return{source:a,target:b}};_d3ns.dragstarted=function(d){d3.event.sourceEvent.stopPropagation();return d3.select(this).classed("dragging",true)};_d3ns.dragged=function(d){var g;g=d3.select(this);physics.particles[d.idx].pos.x+=d3.event.dx;physics.particles[d.idx].pos.y+=d3.event.dy;d.x=physics.particles[d.idx].pos.x;d.y=physics.particles[d.idx].pos.y;return g.attr("transform",function(d){return"translate("+d.x+","+d.y+")"})};_d3ns.dragended=function(d){return d3.select(this).classed("dragging",false)};_d3ns.drag=d3.behavior.drag().origin(function(d){return d}).on("dragstart",_d3ns.dragstarted).on("drag",_d3ns.dragged).on("dragend",_d3ns.dragended);_d3ns.nodes=d3.range(physics.particles.length).map(function(d,i){return{radius:physics.particles[i].radius.toFixed(1),x:physics.particles[i].pos.x,y:physics.particles[i].pos.y,swColor:"#"+(physics.particles[i].colour||"FFFFFF"),swText:"　<-|´･_･`) "+i}});_d3ns.swPartiG=_d3ns.svg.selectAll(".swD3g");_d3ns.vectPath=_d3ns.svg.selectAll(".swD3VectPath");_d3ns.swPartiG=_d3ns.swPartiG.data(_d3ns.nodes);_d3ns.swPartiG.enter().append("g").attr("class","swD3g");_d3ns.swPartiG.append("circle").attr("class","swD3c");return _d3ns.swPartiCir=_d3ns.svg.selectAll(".swD3c")};d3SVGRenderer.prototype.render=function(physics){var line,resample,strokes,voronoies;d3SVGRenderer.__super__.render.call(this,physics);_d3ns.swPartiG.attr("transform",function(d,i){return"translate("+physics.particles[i].pos.x+","+physics.particles[i].pos.y+")"}).on("click",function(d,i){var g;physics.particles[i].fixed=true;physics.particles[i].colour="BCB11B";g=d3.select(this);g.append("text").attr("class","swD3tText2").text(function(d){return _d3ns.nodes[i].swText}).style("font-size",function(d,i){return""+d.radius/1+"px"});g.attr("d",function(d){return d.idx=i});return g.call(_d3ns.drag)});_d3ns.swPartiCir.style("fill",function(d,i){return"#"+physics.particles[i].colour}).attr("r",function(d,i){return physics.particles[i].radius.toFixed(1)});if(this.renderSprings){_d3ns.springsNodes=d3.range(physics.springs.length).map(function(d,i){return{x1:physics.springs[i].p1.pos.x,y1:physics.springs[i].p1.pos.y,x2:physics.springs[i].p2.pos.x,y2:physics.springs[i].p2.pos.y}});_d3ns.vectPath=_d3ns.vectPath.data(_d3ns.springsNodes);_d3ns.vectPath.enter().append("line").attr("class","swD3VectPath");_d3ns.vectPath.attr("x1",function(d){return d.x1}).attr("y1",function(d){return d.y1}).attr("x2",function(d){return d.x2}).attr("y2",function(d){return d.y2}).attr({fill:"none",stroke:"#C0D9FF","stroke-opacity":"0.15","stroke-width":"1px"});_d3ns.vectPath.exit().remove()}_d3ns.moves=d3.range(physics.particles.length).map(function(d,i){return{x:physics.particles[i].pos.x,y:physics.particles[i].pos.y}});_d3ns.voronoiVertices=_d3ns.moves.map(function(o){return[o.x,o.y,o]});switch(true){case _swns.config.vB_hasVoronoi:resample=function(points){var i,n,p0,p1,points2,x0,x1,y0,y1;i=-1;n=points.length;p0=points[n-1];x0=p0[0];y0=p0[1];p1=void 0;x1=void 0;y1=void 0;points2=[];while(++i<n){p1=points[i];x1=p1[0];y1=p1[1];points2.push([(x0*2+x1)/3,(y0*2+y1)/3],[(x0+x1*2)/3,(y0+y1*2)/3],p1);p0=p1;x0=x1;y0=y1}return points2};line=d3.svg.line().interpolate("basis-closed");voronoies=d3.geom.voronoi(_d3ns.voronoiVertices);_d3ns.vPath=_d3ns.vPath.data(voronoies);_d3ns.vPath.enter().append("path").attr("class",function(d,i){return"vPath vP"+i}).attr("d",function(d,i){return"M"+d.join("L")+"Z"}).style({fill:function(d,i){return"#"+physics.particles[i].colour},"fill-opacity":function(d,i){return.88}});_d3ns.vPath.attr("d",function(d,i){return"M"+d.join("L")+"Z"});_d3ns.vPath.exit().remove();break;default:null}end;switch(true){case _swns.config.vB_hasDelaunay:strokes=[];_d3ns.vLinks=[];d3.geom.delaunay(_d3ns.voronoiVertices).forEach(function(d){_d3ns.vLinks.push(_d3ns.edge(d[0],d[1]));_d3ns.vLinks.push(_d3ns.edge(d[1],d[2]));return _d3ns.vLinks.push(_d3ns.edge(d[2],d[0]))});_d3ns.vLink=_d3ns.vLink.data(_d3ns.vLinks);_d3ns.vLink.enter().append("line").attr("class",function(d,i){return"vLine vL"+i}).style("stroke",function(d,i){var _ref3;strokes[i]=(_ref3=physics.particles[~~Random(0,physics.particles.length)])!=null?_ref3.colour:void 0;return"#"+strokes[i]});_d3ns.vLink.attr("x1",function(d){return d.source[2].x}).attr("y1",function(d){return d.source[2].y}).attr("x2",function(d){return d.target[2].x}).attr("y2",function(d){return d.target[2].y});_d3ns.vLink.exit().remove();break;default:null}return end};d3SVGRenderer.prototype.setSize=function(width,height){this.width=width;this.height=height;d3SVGRenderer.__super__.setSize.call(this,this.width,this.height);return _d3ns.svg.attr("width",this.width).attr("height",this.height)};d3SVGRenderer.prototype.destroy=function(){return $("#container svg").remove()};return d3SVGRenderer}(Renderer);